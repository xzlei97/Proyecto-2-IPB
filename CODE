#Autores: Leiner Vega, Johanna Castellon, Angelica Araya


import os                         # Manejo de archivos, carpetas y variables de entorno del sistema 
import pandas as pd               # Manipula y analiza los datos en formato tabular 
import matplotlib.pyplot as plt   # Crea graficos y visualizaciones 
import streamlit as st            # Framework para crear aplicaciones web interactivas 
from Bio import SeqIO             # Lee y escribe archivos de secuencias biologicas (FASTA)
from dotenv import load_dotenv    # Carga variables de entorno desde archivos .env 
from openai import OpenAI         # Cliente para interactuar con la API de OpenAI (GPT) 

# CONFIGURACI칍N INICIAL streamlit

st.set_page_config(page_title="An치lisis de Contenido GC", layout="centered")  # Configura la pagina de Streamlit 
st.title("游빏 Comparaci칩n del contenido GC en genes 16S rRNA")                 # Muestra el titulo principal de la aplicacion 

# Cargar variables de entorno (.env)
load_dotenv()

# Inicializar cliente OpenAI (solo si hay API key en el .dev)
api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=api_key) if api_key else None


# FUNCIONES PRINCIPALES


# Calcular %GC
def calcular_gc(sequence):
    sequence = sequence.upper().replace("\n", "").replace(" ", "")
    g = sequence.count("G")
    c = sequence.count("C")
    a = sequence.count("A")
    t = sequence.count("T")
    total = g + c + a + t
    return round(((g + c) / total) * 100, 2) if total > 0 else 0

# Procesar archivos FASTA
def procesar_fasta(ruta_actual):                                       # Procesa todos los archivos FASTA en una carpeta
    resultados = []                                                    # Almacena los resultados del analisis (bacteria y %GC)
    archivos_encontrados = []                                          # Procesa que archivos fueron encontrados y procesados 
    for archivo in os.listdir(ruta_actual):                            # Recorre todos los archivos en la carpeta que se especifica
        if archivo.endswith(".fasta") or archivo.endswith(".fa"):      # Filtra los archivos con extensiones .fasta o .fa
            archivos_encontrados.append(archivo)                       # Registra como encontrado 
            ruta = os.path.join(ruta_actual, archivo)                  # Construye la ruta completa del archivo 
            try:                                                       # Intenta procesar el archivo con manejo de errores 
                secuencias = list(SeqIO.parse(ruta, "fasta"))          # Lee todas las secuencias del archivo FASTA 
                if len(secuencias) > 0:                                # Verifica que hay al menos una secuencia valida 
                    gc_valores = [calcular_gc(str(seq.seq)) for seq in secuencias]  # Calcula el %GC de cada secuencia usando lista por comprension 
                    gc_promedio = sum(gc_valores) / len(gc_valores)                 # Calcula el promedio de todos los valores GC del archivo 
                    nombre_organismo = os.path.splitext(archivo)[0]                 # Extrae el nombre del organismo (nombre del archivo sin extension)
                    resultados.append({"Bacteria": nombre_organismo, "%GC": gc_promedio})  # Agrega resultados a la lista 
            except Exception as e:                                                         # Identifica cualquier error durante el procesamiento 
                st.error(f"Error al procesar {archivo}: {str(e)}")                         # Muestra un mensaje de error en la interfaz 

    return resultados, archivos_encontrados                                                # Devuelve los resultados y lista de archivos procesados 

# PROCESAMIENTO Y TABLA 

ruta_actual = os.getcwd()
resultados, archivos_encontrados = procesar_fasta(ruta_actual)

if not archivos_encontrados:
    st.warning("No se encontraron archivos .fasta o .fa en esta carpeta.")
    st.info("Aseg칰rate de que los archivos FASTA est칠n en la misma carpeta que este script.")
    st.stop()

st.success(f"Se encontraron {len(archivos_encontrados)} archivo(s) FASTA.")

if not resultados:
    st.error("No se pudieron procesar los archivos FASTA. Verifica el formato de los archivos.")
    st.stop()

df = pd.DataFrame(resultados).sort_values("%GC", ascending=False).reset_index(drop=True)

# FILTRO INTERACTIVO

st.sidebar.header("游댌 Filtro de bacterias")
seleccion = st.sidebar.multiselect(
    "Selecciona bacterias para visualizar:",
    options=df["Bacteria"].tolist(),
    default=df["Bacteria"].tolist()
)

df_filtrado = df[df["Bacteria"].isin(seleccion)]

if df_filtrado.empty:
    st.warning("No hay bacterias seleccionadas. Usa el filtro lateral para seleccionar.")
    st.stop()

# TABLA DE RESULTADOS

st.subheader("游늶 Tabla de resultados")
st.dataframe(df_filtrado, use_container_width=True)

# GR츼FICO

st.subheader("游늵 Gr치fico comparativo del contenido GC")

fig, ax = plt.subplots(figsize=(10, max(6, len(df_filtrado) * 0.4)))
bars = ax.barh(df_filtrado["Bacteria"], df_filtrado["%GC"], color="mediumseagreen", edgecolor="black")

min_gc = df_filtrado["%GC"].min()
max_gc = df_filtrado["%GC"].max()
margen = (max_gc - min_gc) * 0.1
plt.xlim(max(0, min_gc - margen), min(100, max_gc + margen))

for bar in bars:
    ax.text(bar.get_width() + 0.3, bar.get_y() + bar.get_height() / 2,
            f"{bar.get_width():.2f}%", va="center", fontsize=9)

ax.set_xlabel("%GC", fontsize=12)
ax.set_ylabel("Bacteria", fontsize=12)
ax.set_title("Comparaci칩n del contenido GC en 16S rRNA", fontsize=14, fontweight="bold")
ax.grid(axis="x", linestyle="--", alpha=0.6)
ax.invert_yaxis()
plt.tight_layout()
st.pyplot(fig)

# AN츼LISIS RESULTADOS

mayor_gc = df.loc[df["%GC"].idxmax()]
menor_gc = df.loc[df["%GC"].idxmin()]

st.subheader("游늳 An치lisis de resultados")   #referencia de los valores para comprobar respuesta del agente
st.markdown(f"**Mayor contenido GC:** {mayor_gc['Bacteria']} ({mayor_gc['%GC']:.2f}%)")
st.markdown(f"**Menor contenido GC:** {menor_gc['Bacteria']} ({menor_gc['%GC']:.2f}%)")


# AGENTE IA 

if client:   #if se accede a cliente (revisar # Inicializar cliente OpenAI (solo si hay API key en el .dev)), se ejecuta lo siguiente
    st.subheader(" 游 An치lisis generado por IA")

    tabla = df.to_markdown(index=False)

    prompt = f"""
    A continuaci칩n tienes una lista de microorganismos con su contenido GC:

    {tabla}

    Con esta informaci칩n:
    1. Identifica cu치l microorganismo tiene el mayor porcentaje de GC y su porcentaje exacto.
    2. Identifica cu치l tiene el menor porcentaje de GC y su porcentajer exacto. 
    3. Escribe un p치rrafo breve explicando qu칠 significa biol칩gicamente tener alto o bajo contenido GC
    en genes 16S rRNA y c칩mo esto influye en su ecolog칤a o estabilidad gen칩mica.

    Responde en espa침ol de forma clara y breve.
    """

    try:   #parametros para el agente
        respuesta = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "Eres un experto en biolog칤a molecular."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=200
        )
        st.write(respuesta.choices[0].message.content.strip())
    except Exception as e:
        st.warning(f"No se pudo generar el an치lisis autom치tico: {e}")
else:
    st.info(" Para habilitar el an치lisis con IA, configura tu variable `OPENAI_API_KEY` en el archivo `.env`")
